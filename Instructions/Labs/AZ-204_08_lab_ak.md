---
lab:
    title: '实验室：使用 Azure 中的服务创建多层解决方案'
    az204Module: '模块 08：实现 API 管理'
    az020Module: '模块 08：实现 API 管理'
    type: '参考答案'
---

# 实验室: 使用 Azure 中的服务创建多层解决方案
# 学生实验室参考答案

## Microsoft Azure 用户界面

鉴于 Microsoft 云工具的动态特性，Azure UI 在此培训内容开发后可能会发生更改。这些更改可能会导致实验室说明和步骤不匹配。

我们发现社区进行了必要更改时，Microsoft 将会更新此培训课程。但由于云更新频繁，在此培训内容更新前 UI 可能已更改。**如果发生这种情况，请适应这些更改，并根据需要在实验中熟悉这些更改**。

## 说明

### 开始前

#### 登录实验室虚拟机

使用以下凭据登录到 Windows 10 虚拟机 (VM)：
    
-   用户名：**管理员**

-   密码：**Pa55w.rd**

> **注意**：你的讲师将提供连接到虚拟实验室环境的说明。

#### 评价已安装的应用程序

在你的 Windows 10 桌面上找到任务栏。任务栏里有本实验室中你将使用的应用程序的图标：
    
-   Microsoft Edge

### 练习 1 ：利用 Docker 容器映像创建 Azure 应用服务资源

#### 任务 1：打开 Azure 门户

1.  在任务栏上，选择 **“Microsoft Edge”** 图标。

1.  在打开的浏览器窗口中，转到 Azure 门户 (<https://portal.azure.com>)。

1.  在登录页面，输入 Microsoft 帐户的电子邮件地址，然后选择 **“下一步”**。

1.  输入你的 Microsoft 帐户的密码，然后选择 **“登录”**。

    > **注意**：你第一次登录 Azure 门户时会为你提供门户导览。选择 **“开始使用”**，以跳过教程并开始使用门户。

#### 任务 2：利用 httpbin 容器映像使用 Azure 应用服务资源创建 web 应用

1.  在 Azure 门户的导航窗格上，选择 **“创建资源”**。

1.  来自 **新** 边栏选项卡，找到 **搜索市场** 文本框。

1.  在搜索文本框中，输入 **“Web”** 然后按 Enter。

1.  在 **“市场”** 搜索结果边栏选项卡中，选择 **“Web 应用”** 结果。

1.  在 **“Web 应用”** 边栏选项卡中，选择 **“创建”**。

1.  在第二个 **“Web 应用”** 边栏选项卡中，找到边栏选项卡中的“标签页”，例如 **“基础”**。

    > **注意**：每个标签页都代表在工作流中新建 Web 应用的一个步骤。你可以随时选择 **“查看 + 创建”** 跳过其余选项卡。

1.  在 **“基本信息”** 选项卡中，执行以下操作：
    
    1.  将 **“订阅”** 文本框设置为默认值。
    
    1.  在 **“资源组”** 部分，选择 **“新建”**，输入 **“ApiService”**，然后选择 **“确定”**。
    
    1.  在 **“名称”** 文本框中，输入 **httpapi*[yourname]***。

    1.  在 **“发布”** 部分，选择 **“Docker 容器”**。

    1.  在 **“操作系统”** 部分，选择 **Linux**。

    1.  在 **“区域”** 下拉列表中，选择 **“美国东部”地区**。

    1.  在 **“Linux 计划 (美国东部)”** 部分 选择 **“新建”**, 输入 **“名称”** 文本框中的 **“ApiPlan”** 值 , 然后选择 **“确定”**.

    1.  将 **“SKU 和大小”** 部分保留设置为默认值。

    1.  选择 **“下一步：Docker”**。

1.  在 **“Docker”** 选项卡中，执行以下操作：

    1.  在 **“选项”** 下拉列表中，选择 **“单个容器”**。

    1.  在 **“映像源”** 下拉列表中，选择 **“Docker 中心”**。

    1.  在 **“访问类型”** 下拉列表中，选择 **“公共”**。

    1.  在 **“映像与标记”** 文本框中，输入 **kennethreitz/httpbin:latest**。

    1.  选择 **“审阅 + 创建”**。

1.  在 **“评价 + 创建”** 标签页中，评价在上一页步骤中选择的选项。

1.  选择 **“创建”**，使用指定的配置创建 Web 应用。 

    > **注意**：等待创建任务完成，再继续本实验室。

#### 任务 3：测试 httpbin Web 应用程序

1.  在 Azure 门户的导航窗格中，选择 **“资源组”**。

1.  在 **“资源组”** 边栏选项卡中，选择之前在本实验室中创建的 **ApiService** 资源组。

1.  在 **“ManagedPlatform”** 边栏选项卡中，选择你在本实验室的前面部分创建的 **httpapi*[yourname]*** Web 应用。

1.	在 **“Web 应用”** 边栏选项卡中，选择 **“浏览”**。

1.  在 Web 应用程序中，执行以下操作：

    1.  选择 **“响应格式”**。

    1.  选择 **“GET /xml”**。

    1.  选择 **“试用”**。

    1.  选择 **“执行”**。

    1.  观察 **“响应正文”** 和 **“响应标头”** 文本框的值。

    1.  观察 **“请求 URL”** 文本框中的值。

1.  关闭显示 Web 应用程序的浏览器窗口。

1.  返回到 Azure 门户，在 **“Web 应用”** 边栏选项卡中查找 **httpapi*[yourname]*** web 应用。

1.  在 **“Web 应用”** 边栏选项卡的 **“设置”** 部分，选择 **“属性”** 链接。

1.  在 **“属性”** 部分，记录 **“URL”** 文本框的值。稍后将在本实验室中使用此值来对 API 发出请求。

#### 回顾

在本练习中，你使用源自 Docker Hub 的容器映像创建了一个新的 Azure Web 应用。

### 练习2：使用 Azure API 管理构建 API 代理层

#### 任务 1：创建 API 管理资源

1.  在 Azure 门户的导航窗格上，选择 **“创建资源”**。

1.  来自 **新** 边栏选项卡，找到 **搜索市场** 文本框。

1.  在搜索框中，输入 **“API”** ，然后按 Enter 键。

1.  在 **“市场”** 搜索结果边栏选项卡中，选择 **“API 管理”** 结果。

1.  在 **“API 管理”** 边栏选项卡中，选择 **“创建”**。

1.  在 **“API 管理服务”** 边栏选项卡中，执行以下操作：
    
    1.  在 **“名称”** 文本框中，输入 **prodapi*[yourname]***。
    
    1.  将 **“订阅”** 文本框保留设置为默认值。
    
    1.  在 **“资源组”** 列表中，选择你之前在本实验室中创建的 **“ApiService”** 资源组。
    
    1.  在 **“位置”** 列表中，选择 **“美国东部”** 。
    
    1.  在 **“组织名称”** 文本框中，输入 **“Contoso”**。
    
    1.  将 **“管理员电子邮件”** 文本框设置为默认值。
    
    1.  在 **“定价层”** 列表中，选择 **“消耗（99.9 SLA，%）”** 。
    
    1.  选择 **“创建”**。

    > **注意**：等待创建任务完成，再继续本实验室。

#### 任务 2：定义一个新的 API

1.  在 Azure 门户的导航窗格中，选择 **“资源组”**。

1.  在 **“资源组”** 边栏选项卡中，选择之前在本实验室中创建的 **ApiService** 资源组。

1.  在 **“ApiService”** 边栏选项卡中，选择你之前在本实验室中创建的 **prodapi*[yourname]*** API 管理帐户。

1.  在 **“API 管理服务”** 边栏选项卡中，在边栏选项卡左侧的 **“API 管理”** 部分，选择 **“API”** 。

1.  在 **“添加新的 API”** 部分，选择 **“空白 API”**。

1.  在 **“创建空白 API”** 窗口中，执行以下操作：
    
    1.  在 **“显示名称”** 文本框中，输入 **“HTTPBin API”**。
    
    1.  在 **“名称”** 文本框中，输入 **“httpbin-api”**。
    
    1.  在 **“Web 服务 URL”** 文本框中，输入之前在本实验室中复制的 Web 应用 URL。

        > **注**：根据复制 URL 的方式，你可能需要添加前缀“http://”来创建有效的 URL 值。

    1.  将 **“API URL 后缀”** 文本框留空。

    1.  选择 **“创建”**。

    > **注意**：等待新 API 完成创建。

1.  在 **“设计”** 标签页中，选择 **“添加操作”** 。

1.  在 **“添加操作”** 部分，执行以下操作：
    
    1.  在 **“容器名称”** 文本框中，输入 **“Echo 标头”**。
    
    1.  在 **“名称”** 文本框中，输入 **“echo-headers”**。
    
    1.  在 **URL** 列表中，选择 **GET** 。

    1.  在 **URL** 文本框中，输入 **/**。
    
    1.  选择 **“保存”**。

1.	返回 **“设计”** 标签页，在操作列表中选择 **“所有操作”**。

1.	在 **“所有操作”** 的 **“设计”** 部分，找到 **“入站处理”** 磁贴并选择 **“添加策略”**。

1.	在 **“添加入站策略”** 部分，选择 **“设置标题”** 磁贴。

1.	在 **“入站处理，设置标题”** 部分，执行以下操作：
    
    1.  在 **“名称”** 文本框中，输 **入“源”**。
    
    1.  在 **“值”** 文本框中选择列表，选择 **“添加值”**，然后输入 **azure-api-mgmt**。
    
    1.  在 **“操作”** 列表中，选择 **“删除”**。
    
    1.  选择 **“保存”**。

1.	在 **“设计”** 选项卡下，从操作列表中选择 **“回显标头”**。

1.	在 **“回显标头s”** 的 **“设计”** 部分， 找到 **“后端”** 磁贴，然后选择铅笔图标。

1.  在 **“后端”** 部分，执行以下操作：

    1.  在 **“服务 URL”** 部分，选择 **“覆写”** 复选框。

    1.  在 **服务 URL** 文本框中，附加 **/headers** 值到当前值。

        > **注**：例如，如果当前值为 **http://httpapi*[yourname]*.azurewebsites.net** ，新值将是 **http://httpapi*[yourname]*.azurewebsites.net/headers**

    1.  选择 **“保存”** 。

1.	在 **“设计”** 选项卡下，从操作列表中选择 **“回显标头”**。

1.	从 **“测试”** 选项卡，选择 **“回显标头”** 操作。

1.	在 **“应答标题”** 部分，选择 **“发送”**。

1.	观察 API 请求结果。

    > **注意**：作为你请求的一部分，观察一下已发送标头中有多少回显到响应中。具体来说，你会注意到在此任务中创建的新的**源**标头。

1.	选择 **“设计”** 标签页，返回操作列表。

#### 任务 3：操纵 API 响应

1.  在 **“设计”** 标签页中，选择 **“添加操作”**。

1.  在 **“添加操作”** 部分，执行以下操作：
    
    1.  在 **“显示名称”** 文本框中，输入 **“Get Legacy Data”**。
    
    1.  在 **“名称”** 文本框中，输入 **“get-legacy-data”**。
    
    1.  在 “**URL**” 列表中，选择 “**GET**”。
    
    1.  在 **“URL”** 文本框中，输入 **“/xml”**。
    
    1.  选择 **“保存”**。

1.  返回 **“设计”** 选项卡，在操作列表中选择 **“获取旧数据”**。

1.	在 **“测试”** 边栏选项卡中，选择 **“获取遗留数据”** 操作。

1.	在 **“获取遗留数据”** 部分，选择 **“发送”**。

1.	观察 API 请求的结果。

    > **注意**：此时，结果应为 XML 格式。

1.	返回 **“设计”** 选项卡，在操作列表中选择 **“获取旧数据”**。

1.  在 **“获取旧数据”** 操作的 **“设计”** 部分，找到 **“出站处理”** 磁贴，然后选择 **“添加策略”**。

1.  在 **“添加出站策略”** 部分，选择 **“其他策略”** 磁贴。

1.  在策略代码编辑器中，找到以下 XML 内容块：

    ```
    <outbound>
        <base />
    </outbound>
    ```

1.	使用以下 XML 替换该 XML 块：

    ```
    <outbound>
        <base />
        <xml-to-json kind="direct" apply="always" consider-accept-header="false" />
    </outbound>
    ```

1.  在策略代码编辑器中，选择 **“保存”** 。

1.  返回 **“设计”** 选项卡，在操作列表中选择 **“获取旧数据”**。

1.	在 **“测试”** 边栏选项卡中，选择 **“获取遗留数据”** 操作。

1.	在 **“获取遗留数据”** 部分，选择 **“发送”**。

1.	观察 API 请求的结果。

    > **注意**：新结果采用 JavaScript 对象表示法 (JSON) 格式。

1.  在 **“HTTP 响应”** 部分，执行以下操作：

    1.  选择 **“跟踪”**。

    1.  观察 **“后端”** 和 **“出站”** 文本框中的内容。

#### 回顾

在本练习中，你在应用服务资源和任何希望进行搜索查询的开发人员之间生成了代理层级。

### 练习 3：清理订阅 

#### 任务 1：打开 Azure Cloud Shell

1.  在“Azure 门户的导航”窗格，选择 **“Cloud Shell”** 图标以打开一个新的 shell 实例。

    > **注意**： **Cloud Shell** 图标使用大于符号 (\>) 和下划线字符 (\_) 表示。

1.  如果这是你第一次使用订阅打开 Cloud Shell，你可以使用 **欢迎来到 Azure Cloud Shell 向导** 来配置 Cloud Shell 的初次使用。在向导中执行以下操作：
    
    -   对话框提示你在开始使用 shell 前，先新建一个存储帐户。接受默认设置并选择 **“创建存储”**。 

    > **注意**：等待 Cloud Shell 完成首次设置过程后，再继续本实验室。如果 Cloud Shell 配置选项未显示，这很可能是因为你在本课程实验室中使用的是现有订阅。实验是假设你使用的是新订阅的情况下编写的。

#### 任务 2：删除资源组

1.  输入以下命令，然后按 Enter 删除 **ApiService** 资源组：

    ```
    az group delete --name ApiService --no-wait --yes
    ```
    
1.  关闭门户里的 Cloud Shell 窗格。

#### 任务 3：关闭活动应用程序

-   关闭当前正在运行的 Microsoft Edge 应用程序。

#### 复习

在本练习中，你通过删除本实验室中使用的资源组清理订阅。